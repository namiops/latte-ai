# Observability for Agora KNative Serving

## Controller metrics
It's work in progress. The official doc [Serving metrics](https://knative.dev/docs/serving/observability/metrics/serving-metrics).

## Service metrics
In each KService, a Queue-proxy container is exposing service metrics by port `9091` (namely `http-usermetric`).
The list of metrics is available in the official doc [Service metrics](https://knative.dev/docs/serving/services/service-metrics/).

To scrape these metrics on Agora, we need to deploy `ServiceMontior` in your namespace.
Metrics will be scraped at Service objects generated by KService as you can see at `matchLabels` in the example below.
```
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: queue-proxy-monitor
  namespace: <your_namespace>
  labels:
    agora-prom-injected: "true"
spec:
  namespaceSelector:
    matchNames:
    - <your_namespace>
  selector:
    matchLabels:
      networking.internal.knative.dev/serviceType: Private
  endpoints:
  - port: http-usermetric
    path: /metrics
    interval: 30s
    scheme: https
    tlsConfig:
      caFile: /etc/prom-certs/root-cert.pem
      certFile: /etc/prom-certs/cert-chain.pem
      insecureSkipVerify: true
      keyFile: /etc/prom-certs/key.pem
```

**NOTE:**
- Working example is available in [lambda-sample/observability](../../../../k8s/common/lambda-sample/observability)
- More info about related Agora Observability Stack is available at [](../../../runbooks/kube-prometheus-stack/README.md#i-want-to-monitor)
