# To move Keycloak OIDC's IaC out of the CI-automated folder

## Warning

- We cannot import `azuread_service_principal_password` to another TF state. Refer to [doc](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs/resources/service_principal_password#import).
- Then, this operation requires resetting the password.
- Keycload pods are required to restart.

## Steps

### 1 Import Keycloak resources in the new state

**NOTES:** These commands are generated by [gen_tf_migrate.sh](./gen_tf_migrate.sh)

Before merging a PR, run the below cmds in the folder: `infrastructure/terraform/accounts/835215587209/keycloak`.
```
terrafom init
```

For LAB
```
terraform import module.keycloak_oidc_lab.azuread_application.oidc_application "8a200f27-ea3d-488c-b95c-4bc75e99d144"
terraform import module.keycloak_oidc_lab.azuread_service_principal.oidc_principal "ff86c57c-0b1d-4942-9c88-ac1ae795f3a8"
```

For DEV
```
terraform import module.keycloak_oidc.azuread_application.oidc_application "ead36945-9bfe-43ad-8c8c-5fbbe9b58f80"
terraform import module.keycloak_oidc.azuread_service_principal.oidc_principal "1b8104c6-4b31-4fa2-ad67-4590261eeb76"
```

For LAB2
```
terraform import module.keycloak_oidc_lab2.azuread_application.oidc_application "141d31f4-6d33-4b45-bff2-ca697e8b1f1d"
terraform import module.keycloak_oidc_lab2.azuread_service_principal.oidc_principal "5460b210-c037-40bd-bedb-ee525a1dd878"
```

## 2 Make sure that `cityos_vault_keycloak_backend` in vault folder gets the correct password

In `infrastructure/terraform/accounts/835215587209/vault`, run these cmds:

```bash
terraform init
terraform plan
```

You should see that terraform will update the OIDC password on Vault. Then, apply the change

```bash
terraform apply
```

## 3 Remove Keycloak resources from the old state

In `infrastructure/terraform/accounts/835215587209/aad` remove all Keycloak from terraform state.

```bash
terraform init
```

### DEV

```bash
terraform state rm module.keycloak_oidc.data.azuread_client_config.current
terraform state rm module.keycloak_oidc.data.azuread_users.aad_owners
terraform state rm module.keycloak_oidc.azuread_application.oidc_application
terraform state rm module.keycloak_oidc.azuread_service_principal.oidc_principal
terraform state rm module.keycloak_oidc.azuread_service_principal_password.oidc_principal_password
terraform state rm module.keycloak_oidc.time_rotating.oidc_password
```

### LAB

```bash
terraform state rm module.keycloak_oidc_lab.data.azuread_client_config.current
terraform state rm module.keycloak_oidc_lab.data.azuread_users.aad_owners
terraform state rm module.keycloak_oidc_lab.azuread_application.oidc_application
terraform state rm module.keycloak_oidc_lab.azuread_service_principal.oidc_principal
terraform state rm module.keycloak_oidc_lab.azuread_service_principal_password.oidc_principal_password
terraform state rm module.keycloak_oidc_lab.time_rotating.oidc_password
```

### LAB2

```bash
terraform state rm module.keycloak_oidc_lab2.data.azuread_client_config.current
terraform state rm module.keycloak_oidc_lab2.data.azuread_users.aad_owners
terraform state rm module.keycloak_oidc_lab2.azuread_application.oidc_application
terraform state rm module.keycloak_oidc_lab2.azuread_service_principal.oidc_principal
terraform state rm module.keycloak_oidc_lab2.azuread_service_principal_password.oidc_principal_password
terraform state rm module.keycloak_oidc_lab2.time_rotating.oidc_password
```

#### 4 Run terraform plan by hand

Run `terraform plan` on these folders again.

- `infrastructure/terraform/accounts/835215587209/aad`
- `infrastructure/terraform/accounts/835215587209/keycloak`
 
#### 5 Trigger AAD CI pipeline again

Push some commit to this PR. -> there should be no change.


#### 6 Merge the PR 

CI should do nothing about Keycloak Azure App.
