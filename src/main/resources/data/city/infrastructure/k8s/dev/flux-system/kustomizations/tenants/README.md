# Tenancy for Developer Cluster (Dev)

This folder contains values and BUILD target for the `dev` environment for all
Agora tenants.

## Adding a New Tenant

1) **DO NOT EDIT THE FILES DIRECTLY**
    1) The files are generated by the template. Only update the values file
2) Make a new entry in the `dev-values.yaml` file per the schema below
    1) All values as of right now are **mandatory**

## Schema overview

| field              | description                                                                        |
|--------------------|------------------------------------------------------------------------------------|
| **name**           | name of the team                                                                   |
| **branch**         | the 'main' branch to target for changes in infrastructure for tenant               |
| **github_url**     | the WCM GitHub Repository path (will be prefixed by ssh://git@github.tri-ad.tech/) |
| **bootstrap_path** | the path to the folder where Flux should listen for changes                        | 
| **owner_aad**      | the owner AAD UUID for the tenant                                                  |
| **engineer_aad**   | the engineer AAD UUID for the tenant                                               |

## Running the file

You can run the following to check the file

```shell
$ bazel build //infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev
WARNING: Option 'javabase' is deprecated
WARNING: Option 'java_toolchain' is deprecated
INFO: Analyzed target //infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev (0 packages loaded, 0 targets configured).
INFO: Found 1 target...
Target //infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev up-to-date:
  bazel-bin/infrastructure/k8s/dev/flux-system/kustomizations/tenants/kustomization.yaml
INFO: Elapsed time: 0.244s, Critical Path: 0.04s
INFO: 2 processes: 1 internal, 1 darwin-sandbox.
INFO: Build completed successfully, 2 total actions
```

This generates the file but doesn't copy over the details, you can check them by
performing on the target generated:
```shell
$ cat bazel-bin/infrastructure/k8s/dev/flux-system/kustomizations/tenants/kustomization.yaml
```

You can also verify the file will pass CI/CD by performing the following:
```shell
$ bazel test //infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev.copy_test
WARNING: Option 'javabase' is deprecated
WARNING: Option 'java_toolchain' is deprecated
INFO: Analyzed target //infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev.copy_test (0 packages loaded, 0 targets configured).
INFO: Found 1 test target...
Target //infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev.copy_test up-to-date:
  bazel-bin/infrastructure/k8s/dev/flux-system/kustomizations/tenants/generate_tenants_dev.copy_test-test.sh
INFO: Elapsed time: 0.271s, Critical Path: 0.10s
INFO: 2 processes: 2 darwin-sandbox.
INFO: Build completed successfully, 2 total actions
//infrastructure/k8s/dev/flux-system/kustomizations/tenants:generate_tenants_dev.copy_test PASSED in 0.1s

INFO: Build completed successfully, 2 total actions

$ bazel run //infrastructure/k8s/dev:validate
WARNING: Option 'javabase' is deprecated
WARNING: Option 'java_toolchain' is deprecated
INFO: Analyzed target //infrastructure/k8s/dev:validate (0 packages loaded, 0 targets configured).
INFO: Found 1 target...
Target //infrastructure/k8s/dev:validate up-to-date:
  bazel-bin/infrastructure/k8s/dev/validate
INFO: Elapsed time: 0.196s, Critical Path: 0.02s
INFO: 1 process: 1 internal.
INFO: Build completed successfully, 1 total action
INFO: Running command line: external/bazel_tools/tools/test/test-setup.sh infrastructure/k8s/dev/validate infrastructure/k8s/dev 1.21.9 k8s_schema_1_21_9 flux_crd_schema_0_29_INFO: Build completed successfully, 1 total action
exec ${PAGER:-/usr/bin/less} "$0" || exit 1
Executing tests from //infrastructure/k8s/dev:validate
-----------------------------------------------------------------------------
INFO - Validating YAMLs (yq)
...

```
