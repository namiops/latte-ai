# なぜモノレポなのか？

英語版は[こちら](./why-monorepo.md)。

### 開発

モノレポで開発すると、開発者はDevOpsと開発フローのコンテキストを一元化されたCI/CD/DevOpsチームにオフロードすることができます。
これにより、多くの理由でチームが楽になります。

まず、開発の初期参入障壁が低くなるということです。オンボーディングやチーム固有のドメイン知識の必要性が少なくなります。これにより、
JDでDevOpsのスキルを指定する必要がないため、採用の幅が広がり、より早く成長することができます。

さらに、これにより開発者は開発にのみ集中することができます。多くの開発者にとって、DevOpsの管理とアプリケーションの開発を状況に応じて
切り替えることは、仕事の効率を下げてしまいます。開発者が開発だけに集中すればいいのであれば、開発はより速くなります。

また、単一の統一されたシステムを持つということは、CityOSプラットフォームへの統合も容易になるということです。現在、
CityOSプラットフォームはまだ開発中のため、ユーザー向けのドキュメントが少なく、CityOSチームとのコミュニケーションコストが非常に
高いため、多くのチームにとって統合は非常に困難です。各チームが独自に開発を続け、プラットフォームとは異なる方向に進んでしまうと、
後々の移行コストが非常に大きくなり、大変なことになります。

### スケーリング

WCMの規模が大きくなり、より多くのサービスに取り組むチームが増えてくると、マルチレポのアプローチでは管理が難しくなります。これは、
どのコードベースが他のコードベースとインターフェースしているかを追跡するのが難しくなるからです。1つのモノレポにまとめることで、サービス間のコード検索が容易になり、全員の使用状況の管理も
容易になりました。

また、新しいサービスをアーキテクチャに組み込むことも容易になりました。というのも、モノレポに新しいサービスが追加されると、CI/CDや
開発の流れがすべて決まっているからです。レポの設定を変更したり、自分のレポ用に独自のCI/CDを書いたりする必要はありません。また、
すべてのフローを一度に設定することで、単一のフローが正しく効率的であることを確認することができます。全員がそれぞれのフローを設定する
ということは、特にすべてのエンジニアがDevOpsに精通しているわけではない場合、最適化されていない安全性の低いパイプラインになる可能性が
大きくなるということです。

### セキュリティ

すべてをモノレポで管理することで、モノレポ内のすべてのサービスのセキュリティ管理を一元化することができます。セキュリティスキャンツール
やセキュリティレビューのようなものは、CIやプルリクエストのレビューを通じて、開発プロセスに簡単に組み込むことができます。規模が大きく
なれば、マルチレポのアプローチよりもはるかに効率的で管理しやすくなります。

チームがそれぞれ自分のレポを持ち、それを担当する場合、コードのセキュリティを自分たちで維持・管理しなければなりません。これでは、
開発者が開発時に考慮しなければならない他の多くの要素に加えて、別の負担が加わり、何かを見落としやすくなります。影響の大きさという
点では、セキュリティ侵害は最も危険なもののひとつであり、セキュリティのためにリスクを最小限に抑えることは常に目標とすべきことです。

### 依存性

モノレポのアプローチは、すべてのチームで依存関係の管理を容易にします。モノレポでの依存関係をどのように管理するかという点では、
かなり議論の分かれるところですが、計画されているアプローチは、モノレポ内のすべてのサービスにグローバルな依存関係を持たせることです。

グローバルな依存関係を持つことには、いくつかの副作用があります。最も大きなものは、依存関係の更新です。チームが依存関係を更新しよう
とすると、monorepo内のすべてのサービスに対して更新しなければなりません。これは、意図せずに別のサービスを壊してしまう可能性があります。

しかし、グローバルな依存関係が中央のチームによって管理されていれば、依存関係を最新の状態に保ち、コードの品質を最新の水準に維持する
ことがはるかに容易になるというメリットがあります。この利点を応用した重要な例として、世界規模でソフトウェアに影響を与えた最近の
log4jのセキュリティインシデントがあります。今後、同様の性質の事件が発生した場合、グローバルな依存関係管理システムがあれば、モノレポ
のすべてのサービスに対して、ライブラリのセキュリティバグに関するセキュリティ問題を即座に解決することが容易になります。これは、
Python 2.7や古いJavaバージョンなど、サポートが終了する可能性のある他の依存関係にも適用できます。

グローバルな依存関係システムをどのように実装するかの詳細については、または議論していましたが、ここに可能なアプローチの
テクニカルノートがあります。[CityOS依存性管理TN](https://docs.google.com/document/d/12HItRSxW7p7ckgsgMVqvPW7MEZHy_Pz0fott05RECHE/edit)

壊れる可能性のあるアップデートのコストと、セキュリティや依存関係の管理の改善によるメリットを比較すると、モノレポにグローバルな依存関係
システムを導入することは価値があると思います。なぜなら、私たちは常により最新の依存関係を持つように努めるべきだからです。さらに、
現実的に2つの異なるバージョンの依存関係を使用する必要がある場合、多くの依存関係システム（go mod、cargoなど）では、例外を作るために
いくつかの「replace」ディレクティブを指定することができます。つまり、あるサービスがどうしても古いバージョンを必要とするような極端な
状況下では、そのような事態を許容することができるのです。

### 注意点

#### インフラコストとセットアップ

モノレポの難しさの一つは、モノレポを円滑に運営するためのインフラを管理する強力な専門チームが必要なことです。そのために、多くの強力な
ツールやエンジニアを活用する予定です。Bazelのようなツールを使えば、多くの言語に柔軟に対応できるビルドシステムを単一のビルドシステムに
開発することができます。つまり、堅牢で高速なビルドシステムで、ほぼすべての言語に対応できるのです。また、CI/CDチームがCityOSチーム
と一緒に取り組んでいるGitOpsベースのCDシステムをデプロイに利用することで、使いやすいデプロイフローを設定することができます。

#### Bazel

モノレポに移行する際に多くのチームが抱える大きな懸念は、Bazelを学ばなければならないということです。これは事実ですが、必要なのは
Bazelを表面的に学ぶことだけです。Bazelを使って構築することは参入障壁が低く、Bazelをセットアップすることと管理することはかなり大変です。しかし、
Bazelの設定はCI/CDチームが行うので、アプリケーションチームには全く影響がありません。また、チームが独自のレポを選択した場合、
Github ActionsやFluxCDの設定方法など、CI/CDに必要な知識を学ばなければなりません。Bazelの表面的な理解に比べて、個々のリポジトリ
に必要な知識は膨大なものです。

#### 自律性

モノレポに移行する際、多くのチームが懸念するのは、プロジェクトに対する自律性やコントロールが失われることです。プロジェクト自体は、
各チームが完全にコントロールすることができます。つまり、サービスのデプロイメント構成、ツール、プロビジョニングされたリソースなど、
すべての面でチームの管理下に置かれます。開発への影響は、メインブランチのgit履歴やレポのプルリクエストを他のプロジェクトと共有する
ことくらいで、一般的にはごくわずかです。もし、自律性を心配するならCI/CDチームを連絡してくれてお願いします。

#### パワーユーザー

私たちは、すべてのチームがモノレポに参加することを予定していません。いくつかのチームが「パワーユーザー」になることを期待しています。
これは、そのチームがすでに自分たちの開発システムやフローに非常に精通していて、そのユニークな立場を利用して自分たちのシステムを完全
にコントロールしたいと考えていることを意味します。ほとんどの場合、私たちはそのような独自の要件をサポートすることはできませんので、
彼らは自分たちのリポジトリを自由に利用することになります。しかし、ほとんどのケース、ほとんどのチームでは、このようなことはありませんし、
大半のチームはモノレポに位置することになります。

パワーユーザーには、CI/CDチームからのサポートを必要としない知識と経験を持ち、独立して運用することを期待しています。しかし、
彼らを支援する必要があり、十分なリソースがある場合は、支援することが可能です。

次の方法を知っている場合は、パワーユーザーになれる可能性があります。
* githubアクションを管理する
* セキュリティ関連のツール（例：snyk）を有効にする
* 継続的デリバリーを有効にする
* 継続的な展開を有効にする
* CityOSのクラスターに統合する方法を知っている（必要な場合）
* 必要なチーム（CityOS、セキュリティ、ITなど）間のコミュニケーションを処理したい

それ以外の場合は、monorepo内に統合し、CI/CDチームがこれらを処理できるようにすることを強くお勧めします
あなたのための行動！ 