# Rust gRPC usage demo

This folder is an example of how to use gRPC/ProtoBuf in Rust, in a way that is idiomatic in Rust (using tonic/prost)
and compiles using both Bazel and Cargo.

## Overview

This setup uses [tonic](https://github.com/hyperium/tonic) to generate a tokio-based server(+client) from `.proto`
definitions. Tonic uses a Cargo build script to generate `*.rs` definitions for the specified protos, which are then
included in the application code using the `tonic::include_proto!` macro. This is enough for building using Cargo, but
a few additions are needed in order to be able to build using Bazel.

To build with Bazel, we first need a `proto_library` for our `.proto` file. Instead of creating this manually, we rely
on `autogazelle` to generate this for us in the `proto/` folder. Next, we create a `cargo_build_script` to invoke the
build script generating the Rust bindings, and add it as a dependency to the binary.

The different files have `CHANGEME` comments in places that should be changed per project.

## Files in this example

```
├── proto/
│   ├── BUILD.bazel - build file generated by autogazelle (after running `bazel build //ns/rust_grpc_test`). Contains
│   │                 the `voting_proto` target used as a dependency for the build script.
│   └── test.proto  - Proto file containing the service definition to generate Rust bindings for.   
├── src/
│   └── main.rs - Main server source file. Note lines 4-6 that include the generated Rust bindings.
├── BUILD       - BUILD file for the service. Declares the "main" `rust_binary` and the `cargo_build_script` it depends
│                 on. Note the dependency from the `cargo_build_script` on `voting_proto`.
├── Cargo.toml  - Cargo crate definition file. Not much special here, but note that the version of `tonic-build` here
│                 has to match the dependency version used in the `BUILD` file. Since dependency versions are shared
│                 across our workspace, please _DON'T_ change the `tonic`/`tonic-build` version yourself.
├── gen.rs      - The Cargo build script compiling the `.proto` files to `.rs`.
└── README.md   - This readme.
```

## FAQ

#### Why not use the "official" Rust gRPC rules?

The current implementation of [`rules_proto_grpc`](https://rules-proto-grpc.com/en/latest/lang/rust.html) for Rust
generates Rust bindings based on the "default" Rust protoc plugin. However, the bindings generated by this plugin are
incompatible with [tokio](https://github.com/tokio-rs/), the de-facto standard for asynchronous programming in Rust.
Instead, the tokio project provides its own tool for generating Rust bindings, `prost`. While there is a
[protoc plugin](https://github.com/neoeinstein/protoc-gen-prost) for `prost`, it is not "official" and work to integrate
it with `rules_proto_grpc` appears to be stalled:

* Protobuf rules using Tonic [rules_rust#478](https://github.com/bazelbuild/rules_rust/issues/478)
* Replace rust rules with new prost and tonic rules [rules_proto_grpc#202](https://github.com/rules-proto-grpc/rules_proto_grpc/pull/202).
* Tonic/Prost Rules - Take 2 [rules_rust#595](https://github.com/bazelbuild/rules_rust/pull/595)

#### Why is this so verbose? Can't you make a macro/rule to simplify this?

Yes, we should definitely do this! However, to do this properly, we would ideally like to also generate the build script
and the module definition (`include_proto!` call), so we haven't gotten around to it yet.
