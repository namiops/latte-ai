# IoTA - Over the air (OTA)
## Overview
This folder houses the application code for the Over-The-Air (OTA) service. It encapsulates the logic for integrating IoT Agent (IoTA), IoT Agent Shadow, and Amazon S3 to facilitate the backend processes of uploading, downloading, and distributing software versions to devices.

## Design documents
* https://wovencity.monday.com/docs/5104393886
* https://wovencity.monday.com/docs/5347982874

## Used by
* `IoTA Service`: As a gateway to access Over-The-Air functionality for S3 related tasks.

## Dependencies
* `S3`: Provides access to the necessary S3 services for the Over-The-Air (OTA) functionality, including file storage and retrieval by providing access through the pre-signed URL.

## Accessing OTA
### Local
see [Development](#development)

### Lab and Dev
OTA is close to external access, we have to port forward to interact with the knative-serving's activator pod in desired revision.
[ref](https://github.com/wp-wcm/city/blob/main/infrastructure/docs/runbooks/knative/serving/onboard-guideline.md#port-forwarding-for-local-debugging)

```sh
kubectx lab|dev
```

```sh
kubectl port-forward -n knative-serving svc/activator-service 8888:80
OTA_REVISION_FOR_LOCAL_DEV=$(kubectl get revisions -n iot -l serving.knative.dev/service=iota-ota --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1:].metadata.name}')
curl localhost:8888/tenants/test/groups/ota-test-group/releases -H "Knative-Serving-Namespace: iot" -H "Knative-Serving-Revision: $OTA_REVISION_FOR_LOCAL_DEV"
```

# Development
## Serverless
The IoTA-OTA is deployed to serverless, please see the serverless resource at
https://github.com/wp-wcm/city/tree/main/infrastructure/k8s/common/iot/iota-ota

## OpenAPI-based code
The base code in this project was generated by the [oapi-codegen](https://github.com/deepmap/oapi-codegen) utility.
This generates support code in the pkg/ota directory.

The generated code MUST not be edited manually, as it will be overwritten if and when the YAML specification for the service changes. See the file api/ota.yaml to see the specification from which this code is generated.

to re-generate the oapi code run
```sh
oapi-codegen -config generator-configs/lib.yaml api/ota.yaml
```

## Run it in VS code
Add this to configuration
```
        {
            "name": "Launch OTA",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "iot/iota-ota/main.go",
             "args": [
                "--db-dsn",
                "postgresql://<user>:<pass>@localhost:5432/sus_history?sslmode=disable",
                "--tenant-mappings",
                "{ \"test-byob\": \"<BYOB_BUCKET>\"}"
            ],
            "env": {
                "AWS_ACCESS_KEY_ID":"<AWS_ACCESS_KEY_ID>",
                "AWS_SECRET_ACCESS_KEY":"<AWS_SECRET_ACCESS_KEY>",
                "AWS_SESSION_TOKEN": "<AWS_SESSION_TOKEN>",
                "COMMON_BUCKET_NAME": "<COMMON_BUCKET_NAME>",
                "BASE_DIR": "ota",
            },
        }
```

### AWS account for bucket
As of Dec 8 2023, we are using the main lab/dev shared account. This is not the official solution yet. In the
future we would want to use these official approach such as
* TN-0373 BYO AWS https://docs.google.com/document/d/1Uac8ESK6Uf83kNqg7vJvTcs1MM6L4S5N8Yonhr5FMlw/edit#heading=h.t2wwxeng0uj4
* TN-0368 Agora Object Storage https://docs.google.com/document/d/1xm_XDeWRXIeqkWeJIn8Z8CUOjKQGEzHAVin46PRwsbg/edit#heading=h.t2wwxeng0uj4

#### Running locally developer can use one of the following
- the sandbox account, see https://developer.woven-city.toyota/docs/default/Component/iota-service/Tutorials/04_sus_byob/ for detail how to setup byob for yourself, the process is same as onboarding byob client and then onboard yourself locally by updating config map at args in `launch.json` or ENV
- (deprecated soon) use the shared bucket `agora-lab-iot-ota` in lab(370564492268) to directly connect to shared lab account.
  - to obtain the AWS credentials for this account:
    - access the AWS web UI at https://woven.awsapps.com/start#/
    - select `services-default-dev-Z278lss`
    - select `Command line or programmatic access` to show the access keys and tokens

## Running test
### Unit test
#### Mocking
We use [mockery](https://vektra.github.io/mockery/latest/) to generate mocks for our tests.

1. Comment the interface with `//go:generate` e.g.
```go
//go:generate mockery --name S3Client --filename s3-client.go
type S3Client interface {
```
2. Run go generate to regenerate the mock
```sh
go generate ./...
```
#### Run the tests
```sh
 bazel test //ns/iot/iota-ota/...
```
#### Get to code coverage
```sh
bazel run @go_sdk//:bin/go -- test -coverprofile=c.out
bazel run @go_sdk//:bin/go -- tool cover -html=c.out
```

### Integration test
See [integration](integration/README.md)

### Allowing a Team to BYOB
Users should be directed to our [quickstart tutorial](https://developer.woven-city.toyota/docs/default/Component/iota-service/Tutorials/04_sus_byob/).

On our end we need to:
* Update our `ServiceEntry` to allow us to access their S3 Bucket
    * [lab2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/lab2/clusters/worker1-east/iot/serviceentry-aws.yaml)
    * [dev2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/iot/serviceentry-aws.yaml)
    * [prod](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/prod/service-entries.yaml)
* Update TF config, this will AWS role permission to access their bucket/key, setup SQS and config provider for tenant
    * [lab2](https://github.com/wp-wcm/city/blob/main/infrastructure/terraform/environments/lab2/base/worker1_east-iot.tf)
    * [dev2](https://github.com/wp-wcm/city/blob/main/infrastructure/terraform/environments/dev2/base/worker1_east-iot.tf)
    * [dev](https://github.com/wp-wcm/city/blob/main/infrastructure/terraform/environments/dev2/base/worker1_east-spw_dev_iot.tf)
    * [prod](https://github.com/wp-wcm/city/blob/main/infrastructure/terraform/environments/prod/accounts/platform-internal/iot-main.tf)
    * Check if this tenant has been onboard to config-provider, if not then update the Config-Provider, get the KMS key from TF apply result above, you can search the IDs from output <env_name>-iota_config_provider_kms_key_ids
        * [lab2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/lab2/clusters/worker1-east/iot/iota-config-provider/config-map.yaml)
        * [dev2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/iot/iota-config-provider/config-map.yaml)
        * [dev](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/dev/config-provider/config-map.yaml)
        * [prod](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/prod/config-provider/config-map.yaml)
* Create PR to add an entry to our BYOB configmap
    * OTA service - to map their tenant to their bucket
        * [lab2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/lab2/clusters/worker1-east/iot/iota-ota/byob-map.yaml)
        * [dev2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/iot/iota-ota/byob-map.yaml)
        * [dev](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/dev/iota-ota/byob-map.yaml)
        * [prod](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/prod/iota-ota/byob-map.yaml)
    * OTA Event service - to map their tenant to our SQS, SQS should be created under worker-1-east account with the name agora-<env>2-iota-<tenant>-events please check https://ap-northeast-1.console.aws.amazon.com/sqs/v3/home?region=ap-northeast-1#/queues 
        * [lab2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/lab2/clusters/worker1-east/iot/iota-ota-events-consumer/patches/ota-events-consumer-config-map.yaml)
        * [dev2](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/iot/iota-ota-events-consumer/patches/ota-events-consumer-config-map.yaml)
        * [dev](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/dev/iota-ota-events-consumer/patches/ota-events-consumer-config-map.yaml)
        * [prod](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/prod/iota-ota-events-consumer/patches/ota-events-consumer-config-map.yaml)
    * Config Provider
        * [prod](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/dev/config-provider/config-map.yaml)
        * [prod](https://github.com/wp-wcm/city/blob/main/infra/k8s/agora-iot/speedway/prod/config-provider/config-map.yaml)
Restart the deployment to pull the configmap change (we'll look at other solution to this as well)

You can use this [reference PR](https://github.com/wp-wcm/city/pull/23306/files) as a guide on what to do.

### Install psql

See instruction [here](https://www.postgresql.org/download/)

### Running SUS DB Locally

To speedup local development, we have a `docker-compose.yaml` present under `internal/db/rds`, which can be run with the 
usual `docker compose up -d` (omit the `-d` if you want to see the output in your terminal). 

```bash
cd internal/db/rds
docker compose up -d
```

You can also `exec` into the container with `docker exec -it <container_id> bash` and run `psql -U postgres` to login 
manually and hack away with SQL.

```bash
docker exec -it rds-postgres-1 bash
psql -U postgres -d sus_history
```

Using the connection details specified in the `docker-compose.yaml` we can add the following environment variable to 
connect the OTA server to the DB:

```
--db-dsn "postgresql://postgres:<pwd>@localhost:5432/sus_history?sslmode=disable"
```

or update args the launch.json like this
```json
        {
            "name": "Launch OTA",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "iot/iota-ota/main.go",
         "args": [
                "--db-dsn",
                "postgresql://postgres:toor@localhost:5432/sus_history?sslmode=disable",
                "--tenant-mappings",
                "{ \"test-byob\": \"<BYOB_BUCKET>\"}"
            ],
            "env": {
                "AWS_ACCESS_KEY_ID":"<AWS_ACCESS_KEY_ID>",
                "AWS_SECRET_ACCESS_KEY":"<AWS_SECRET_ACCESS_KEY>",
                "AWS_SESSION_TOKEN": "<AWS_SESSION_TOKEN>",
                "COMMON_BUCKET_NAME": "<COMMON_BUCKET_NAME>",
                "BASE_DIR": "ota",
            },
        }
```

This will trigger the server to create the tables when it starts up, generate a dummy `Release` and `Distribution` 
for you to play around with, and drop the tables when you close the server.

※ If you encounter the issue when running a server with an error like `database "sus_history" does not exist`, then you can create `sus_history` database with logging manually into the postgres and execute

```
CREATE DATABASE sus_history;
```

## How to access RDS from pod in cluster
### Speedway Dev
Getting login info
```bash
kubectl -n agora-iot-dev get secret rds-secret --as agora-iot-dev-admin -o json | jq '.data | map_values(@base64d)'
```

Getting password
```bash
kubectl -n agora-iot-dev get secret rds-synced-secret --as agora-iot-dev-admin -o json | jq '.data | map_values(@base64d)'
```

then exec to `dummy-pod` it has psql installed, use the information from secret above
```
kubectl exec -it dummy-pod  -n agora-iot-dev --as agora-iot-dev-admin -- sh
PGSSLMODE=require  psql -h <host> -p <port> -U <username> -d <name>
```