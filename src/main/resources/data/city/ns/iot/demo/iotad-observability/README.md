# IoTAD + OTEL/Syslog Demo

This codebase is a simple demo showing how to use [IoTAD](https://developer.woven-city.toyota/docs/default/Component/iota-service/Tasks/iotad/) as a daemon (background service) utility to help with forwarding OTEL/Syslog messages generated by your iot device to the observability piplines through MQTT. 

## Preparations

Before getting started, make sure you have [IoTAD](https://developer.woven-city.toyota/docs/default/Component/iota-service/Tasks/iotad/) installed and the configuration files have been created and put in the right place. Please check [IoTAD](https://developer.woven-city.toyota/docs/default/Component/iota-service/Tasks/iotad/) page for details.

As the name of IoTAD suggests, it's designed to be a program running on the same machine with your application (i.e. OTEL message generator), be it a physical machine, a VM, or a Container. 

## IoTAD + OTEL

In our IoTAD + OTEL example, The IoTAD and [a sample OTEL generator binary](https://github.com/wp-wcm/city/tree/e5ec4bf8c32d566e7c140509f19d4563a283de82/ns/demo/otel-generator) have been inside an image. You can pull this demo image from our [Artifactory](https://artifactory-ha.tri-ad.tech/ui/repos/tree/General/docker/wcm-cityos/services/iotad-otel).

1. Navigate to `iota-otel` folder.
2. Prepare your `.iota` folder with `iotad.json` inside.
3. Build the binaries and images.
   ```shell
   ./setup.sh
   ```
4. Start up the container.
   ```shell
    docker run -it iotad-otel
   ```
5. You should be able to see iotad starts the OTEL server at `127.0.0.1:4318` and starts to receive the logs from the sample OTEL generator. And you will also find these logs on our [obesevability platform](https://observability.agora-lab.woven-planet.tech/grafana/d/569ef518df53e079e43c60b6f2fa95b00fd20b0b/log-collector-logs-per-tenant?orgId=1&refresh=5s). At the moment, `logs` and `traces` are supported and we are working on supporting `metrics`.
   
## IoTAD + Syslog

Similiarly, IoTAD also acts as a syslog server and it supports forwarding syslog messages to to the observability pipline. To do that, you simply need set up the syslog exporter's target address to be `127.0.0.1:1514`. For example, try below steps:
1. Get IoTAD up and running
   ```shell
   ./iotad
   ```
2. Use [Docker syslog logging driver](https://docs.docker.com/config/containers/logging/syslog/) to forward syslog to iotad's syslog server:
   ```shell
   docker run --log-driver syslog --log-opt syslog-address=udp://127.0.0.1:1514 alpine echo hello world
   ```
   > **⚠️ IMPORTANT NOTE:** We have found Docker syslog logging driver cannot forward syslogs properly on MacOS. So it's better to use Docker syslog logging driver in Linux machine
3. You will find the "hello world" syslog message has been collected by iotad and forwarded to our [obesevability platform](https://observability.agora-lab.woven-planet.tech/grafana/d/569ef518df53e079e43c60b6f2fa95b00fd20b0b/log-collector-logs-per-tenant?orgId=1&refresh=5s)
