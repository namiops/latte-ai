# Migrating your application from Agora `dev` to `pre-prod`

!!! Warning
    The migration process below may be subject to changes with infrastructure updates. Please refer to the working examples and/or [contact us](https://toyotaglobal.enterprise.slack.com/archives/C02CVJLTMJ7) if you need assistance.

## Overview

This guide will walk you through migrating an application that has already been deployed in the Agora `dev` environment to the `pre-prod` cluster.

!!! Note
    The steps below may also be used to onboard a brand new application into the `pre-prod` environment with some slight modifications. If this is your use case, please [contact us](https://toyotaglobal.enterprise.slack.com/archives/C02CVJLTMJ7) for more details.

## What you'll learn

* [1. Common steps](#1-common-steps)
  * [a. Migrate your tenant and namespace](#a-migrate-your-tenant-and-namespace)
  * [b. Set your team as the code owners](#b-set-your-team-as-the-code-owners)
* [2. Steps for migrating Agora components](#2-steps-for-migrating-agora-components)
  * [Service mesh](#service-mesh)
  * [Keycloak/Drako](#keycloakdrako)
  * [CityService](#cityservice)
  * [Kafka](#kafka)
  * [Vault](#vault)
  * [PostgreSQL](#postgresql)
  * [Redis](#redis)
  * [SecureKVS](#securekvs)
  * [IoT/IoTA](#iotiota)
* [3. Verify your application status](#3-verify-your-application-status)

## What you'll need

Before you start, you need to have access to Agora's clusters to check your services and set the necessary credentials for running your application. If you haven't done so, use the links below to get started on the respective pre-requisites:

* Access to the following **Kubernetes clusters**:
  * [`dev`](https://github.com/wp-wcm/city/tree/main/infrastructure/k8s/dev)
  * [`pre-prod`](https://github.com/wp-wcm/city/tree/main/infrastructure/k8s/environments/dev2)
* Set up **Vault secrets** for your app (if applicable):
  * [Pre-requisites](https://github.com/wp-wcm/city/blob/main/ns/vault/docs/setup.md#pre-requisites)
  * [Setup instructions](https://github.com/wp-wcm/city/blob/main/ns/vault/docs/setup.md#how-to-set-up-a-vault-secret-engine)

!!! Note
    If your application uses our platform components (such as City Service/Keycloak, Kafka, Postgres, etc.), please [contact the DevRel team](https://toyotaglobal.enterprise.slack.com/archives/C02CVJLTMJ7) to discuss the setup and configurations.

## Steps

### 1. Common steps

#### a. Migrate your tenant and namespace

For the detailed steps on how to migrate your tenant and namespace onto `pre-prod`, see [this document](04-tenant-namespace-dev-to-preprod.md).

When you are done, create and submit a pull request for the changes.

#### b. Set your team as the code owners

Set your team as the code owner for `infrastructure/k8s/common/NAMESPACE_NAME/SERVICE_NAME` in the CODEOWNERS file, and submit a pull request for the changes.

Currently, after the manifest files are generated by Agoractl, the DevRel team needs to review the pull request before deployment. In future when the tool is more stable and released, you will be able to run auto-generation without the `â€“no-git` option and merge the files directly.

To learn more about Agoractl, see the [GitHub documentation](https://github.com/wp-wcm/city/tree/main/ns/agoractl).

### 2. Steps for migrating Agora components

Depending on what Agora components your application is using, refer to the following sections for details on how to migrate each piece from `dev` to `pre-prod`.

#### Service mesh

Create a VirtualService in each namespace. For the `spec.gateway` in the VirtualService, specify the gateway defined at the following link: [virtualgateway-default-city-pri-90b4823ff24cd3bd6f637b5d88d2255](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/city-private-ingress/ungloo/gateways-virtualgateway-default-city-pri-90b4823ff24cd3bd6f637b5d88d2255.yaml).

Below is an example of a VirtualService. The `exportTo` field must be removed as it can break routing.

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: test-city-private-ingress
  namespace: test
spec:
  # Remove the exportTo field as it can break routing
  # exportTo:
  #   - .
  gateways:
    - city-private-ingress/virtualgateway-default-city-pri-90b4823ff24cd3bd6f637b5d88d2255
  hosts:
    - test.agora-lab.w3n.io
```

Here are some example pull requests for reference:

* [#25374](https://github.com/wp-wcm/city/pull/25374)
* [#25379](https://github.com/wp-wcm/city/pull/25379)

#### Keycloak/Drako

If your application already has Keycloak set up in `dev`, simply copy the file `infrastructure/k8s/dev/id/keycloakclient-YOUR_APPLICATION.yaml` into `infrastructure/k8s/common/APP_NAMESPACE/auth/base`.

After that, remove the line `namespace` from the YAML file. Create a `dev` folder under the `auth/` subdirectory, and a file in `dev` as follows:

```yaml title="kustomization.yaml"
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../base
```

#### CityService

CityService is not provided in `pre-prod`, so it is necessary to extract the resources generated by CityService from `dev` and apply them to `pre-prod`. To extract the resources, please use the following extract script:
[CityService Extract Script](https://github.com/wp-wcm/city/tree/main/ns/cityos-system/cityservice-operator-go/tools/extract)

#### Kafka

We recommend using the [Kafka generation process](https://github.com/wp-wcm/city/blob/main/ns/kafka-docs/docs/01_quickstart.md) provided by Agora to help guarantee the behavior of your instance of Agora MSK.

#### Vault

If your app is using Vault, you need to update the Vault annotation in your deployment as follows:

1. Add an agent user ID:

    ```plain
    annotations: vault.hashicorp.com/agent-run-as-user: "1337"
    ```

2. Update your Vault instance from `dev` to `pre-prod`:

    ```plain
    vault.hashicorp.com/agent-inject-secret-config: "kubernetes-preprod/your-application"
    vault.hashicorp.com/auth-path: "auth/kubernetes-preprod"
    ```

#### PostgreSQL

We recommend using the [Postgres Zebra target](https://developer.woven-city.toyota/docs/default/Component/postgres-service/01_postgres-zebra/) provided by Agora to help guarantee the behavior of your instance of Agora MSK.

!!! Info
    For users with legacy PostgresClusters, two primary changes have been made that are important to note: The [Zalando Operator](https://github.com/zalando/postgres-operator) replaces the [CrunchyData Operator](https://github.com/CrunchyData/postgres-operator), and the Agora team maintains [Helm Charts to help deploy Postgres](https://github.com/wp-wcm/city/tree/main/infrastructure/helm/agora-zalando-postgresql) into the cluster to allow proper communication between pods via the service mesh.

#### Redis

We recommend that you use the [Redis Helm Chart](https://github.com/wp-wcm/city/tree/main/infrastructure/helm/agora-redis) and follow the instructions [here](https://github.com/wp-wcm/city/blob/main/ns/tutorial/redis-101/en/docs/03_zebra_usage.md).

* For more information about the Redis Operator, see the [Operator Documentation](https://github.com/spotahome/redis-operator)

#### SecureKVS

We recommend using Agoractl to generate your SecureKVS in the new `pre-prod` environment as follows:

```shell
bazel run //ns/agoractl -- securekvs --help
```

You should see the following output:
  
```shell
usage: agoractl securekvs [-h] [-env {lab2,dev2}] [-n NAME] [-ns NAMESPACE] [-o OUTPUT] [-s SERVICEACCOUNT]

Agoractl SecureKVS
------
This plugin helps you create a database inside the Secure KVS CouchDB.
It also adds an Access Policy, which will allow you access to the created database.

This plugin will create two new files and edit a file in the environment you selected:
  - The two new files set up a zebra macro that will generate CouchDBDatabase kind. CouchDB Operator will use this kind to create the db for you.
  - The edited file is part of a different zebra macro. 

The easiest way to use all the generated Zebra files is to open a PR and wait for Zebra bot to push the files to your branch. At first, the pipeline will fail. This is the expected behavior.

Note. If you want to rerun this command for some reason. Make sure to discard previous changes.

options:
  -h, --help            show this help message and exit
  -env {lab2,dev2}, --environment {lab2,dev2}
                        the desired environment
  -n NAME, --name NAME  the database name suffix. The final name will be 'namespace_suffix'
  -ns NAMESPACE, --namespace NAMESPACE
                        the namespace of the database
  -o OUTPUT, --output OUTPUT
                        output path to push files, this is from the root of the city repository. For best result use a sub directory eg. '<your-project>/secure-kvs'
  -s SERVICEACCOUNT, --serviceaccount SERVICEACCOUNT
                        the name of the service account to give access to
```

#### IoT/IoTA

To establish communication with RabbitMQ correctly, you need to create your namespace folder under [`rabbitmq/resources/`](https://github.com/wp-wcm/city/tree/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/iot/rabbitmq/resources).

Then, add your namespace (in alphabetical order) to [`rabbit-annotations.patch.yaml`](https://github.com/wp-wcm/city/blob/main/infrastructure/k8s/environments/dev2/clusters/worker1-east/iot/rabbitmq/patches/rabbit-annotations.patch.yaml).

!!! Note
    If you need a `Vhost`, contact the [Agora Services Team](https://toyotaglobal.enterprise.slack.com/archives/C02CVJLTMJ7) for assistance.

For more information on the use of IoTA and how to set various broker resources, see the [Developer Portal](/docs/default/Component/iota-service/Concepts/Data%20Broker/00_rabbitmq-crd/).

### 3. Verify your application status

After you have migrated all the necessary components, make sure to verify that your application is accessible on Agora.

## Troubleshooting

If you encounter issues or need support, or if you have any feedback about this document or the migration process, please feel free to [contact the DevRel Team](https://toyotaglobal.enterprise.slack.com/archives/C02CVJLTMJ7) anytime!
