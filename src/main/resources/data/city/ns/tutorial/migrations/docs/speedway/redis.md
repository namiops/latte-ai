# Redis setup on Speedway

This document is meant to be a self service guide on configuring Redis on Speedway.

!!! Note
    Please note that the process for setting up Redis may change in future. We will constantly update this guide with the latest information.

This document focuses only on setting up Redis on Speedway. For more detailed information about Redis provided by Agora, please refer to [this link](https://developer.woven-city.toyota/docs/default/component/redis-tutorial/en/00_index/).

## Setup Redis

You will create several configuration files and execute bazel commands.

The setup process will be done in the following order:

- `redis-values.yaml`
- `BUILD`
- `bazel run` (to generate necessary files for Redis operation)
- `kustomization.yaml`
- `bazel run //:gazelle`

The Redis setup will be structured as follows:

```sh
 % tree
.
├── BUILD
├── kustomization.yaml
├── out
│   └── YOUR_REDIS_NAME
│       ├── BUILD
│       ├── authorizationpolicy-redis-authpol-YOUR_REDIS_NAME.yaml
│       ├── kustomization.yaml
│       ├── redisfailover-YOUR_REDIS_NAME-redis.yaml
│       ├── service-YOUR_REDIS_NAME-redis-headless.yaml
│       └── service-YOUR_REDIS_NAME-sentinel-headless.yaml
└── redis-values.yaml
```

1. Create redis-values.yaml

    Create a file named `redis-values.yaml` with the following content:

    ```yaml
    name: YOUR_REDIS_NAME
    redis:
      replicas: 3
      image: redis:6.2.6-alpine
    sentinel:
      replicas: 3
      image: redis:6.2.6-alpine
    redisFailoverLabels:
      security.istio.io/tlsMode: istio
    targetEnv: speedway-prod # Replace with speedway-dev for Speedway DEV environment or speedway-prod for Speedway PROD environment
    ```

    Please change the above values accordingly:

    - `name: YOUR_REDIS_NAME`
    - `targetEnv:` Set to `speedway-dev` for Speedway DEV environment or `speedway-prod` for Speedway PROD environment.

    For more detailed values, please refer to [agora-redis helm chart values list](https://github.com/wp-wcm/city/blob/main/infrastructure/helm/agora-redis/README.md#values)

2. Create BUILD

    Create a `BUILD` file and add the following Bazel target:

    ```bazel
    load("//ns/redis-operator/bazel:redis_build.bzl", "DEFAULT_CHART", "redis_build")

    redis_build(
        name = "YOUR_REDIS_NAME",
        chart = DEFAULT_CHART,
        namespace = "YOUR_NAMESPACE",  # Replace with your namespace
        values_file = "redis-values.yaml",
    )
    ```

    Please change the above values accordingly:

    - `name: YOUR_REDIS_NAME`
    - `namespace:` Replace with your namespace.

3. bazel run :YOUR_REDIS_NAME.copy

    From the directory containing the `BUILD` file, execute the following command:

    ```bazel
    bazel run :YOUR_REDIS_NAME.copy
    ```

    Please change the above values accordingly:

    - `:YOUR_REDIS_NAME.copy` with your Redis name. For example, if your Redis name is service-redis, the command will be `bazel run :service-redis.copy`.

4. Update kustomization.yaml

    Add the generated `out/YOUR_REDIS_NAME` to the resources in `kustomization.yaml`:

    ```yaml
    apiVersion: kustomize.config.k8s.io/v1beta1
    kind: Kustomization
    resources:
      - out/YOUR_REDIS_NAME
    ```

5. bazel run //:gazelle

    ```bazel
    bazel run //:gazelle
    ```

6. Verify the directory structure

    After completing steps 1 to 5, verify that the directory structure matches the following. If it does, the Redis setup is complete.

    ```sh
    % tree
    .
    ├── BUILD
    ├── kustomization.yaml
    ├── out
    │   └── YOUR_REDIS_NAME
    │       ├── BUILD
    │       ├── authorizationpolicy-redis-authpol-YOUR_REDIS_NAME.yaml
    │       ├── kustomization.yaml
    │       ├── redisfailover-YOUR_REDIS_NAME-redis.yaml
    │       ├── service-YOUR_REDIS_NAME-redis-headless.yaml
    │       └── service-YOUR_REDIS_NAME-sentinel-headless.yaml
    └── redis-values.yaml
    ```

7. Commit changes to the City repo

## Connecting to Redis from your Application

There are two ways to connect to Redis:

1. Connecting to Sentinel nodes (using `service-YOUR_REDIS_NAME-sentinel-headless.yaml`)

    - Recommended for high availability.
    - Port: `26379`
    - Install the Sentinel library for your programming language.
    - Refer to the Redis Sentinel Documentation:
      - <https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/>
      - <https://redis.io/docs/latest/develop/reference/sentinel-clients/>

2. Connecting to Redis nodes (using `service-YOUR_REDIS_NAME-redis-headless.yaml`)

    - Use this option for initial connectivity checks or usage before Sentinel library setup.
    - Port: `6379`

### Connection Example

Example configuration for `kubernetes` deployment.yaml:

Replace the `value` of `REDIS_HOST` with the names generated by `bazel run :YOUR_REDIS_NAME.copy` for:

- `service-YOUR_REDIS_NAME-redis-headless.yaml`
- `service-YOUR_REDIS_NAME-sentinel-headless.yaml`

Connecting to Sentinel nodes

```yaml
        - name: REDIS_PORT
          value: "26379"
        - name: REDIS_HOST
          value: YOUR_REDIS_NAME-sentinel-headless.YOUR_NAMESPACE.svc.cluster.local
```

Connecting to Redis nodes

```yaml
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_HOST
          value: YOUR_REDIS_NAME-redis-headless.YOUR_NAMESPACE.svc.cluster.local
```

The setup for connecting to Redis is complete. Please check for any connection errors in your application.

If you have any questions please reach out to Devrel on [#wcm-org-agora-devrel](https://toyotaglobal.enterprise.slack.com/archives/C0415J5P1FD)
