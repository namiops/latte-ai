# Document Onboarding Runbook

Version 0.1.0

This README is meant to help DevRel Engineers onboard a team to the Developer
Portal. After this a few files should be produced to help a team use the
Developer Portal, as well as an update to the Developer Portal's image

## Prerequisites

* **ytt**
    * Installation
      instructions: [here](https://carvel.dev/ytt/docs/latest/install/)
* Be in this directory (`/ns/developer/scaffold`)

## Steps

**1) Teams will provide the requested details to us. This should be done via the
   operational workflow provided by DevRel on the AMA Channel. Fill in the
   values into the `schema/values.yaml`**

**2) After values are uploaded into the `schema/values.yaml`, run the following:**

```shell
$ bazel build //ns/developer/scaffold:devportal_onboarding
```

You'll get something like the following:

```
WARNING: Option 'javabase' is deprecated
WARNING: Option 'java_toolchain' is deprecated
INFO: Analyzed target //ns/developer/scaffold:devportal_onboarding (1 packages loaded, 10 targets configured).
INFO: Found 1 target...
Target //ns/developer/scaffold:devportal_onboarding up-to-date:
  bazel-bin/ns/developer/scaffold/catalog-info.yaml
INFO: Elapsed time: 0.173s, Critical Path: 0.03s
INFO: 1 process: 1 internal.
INFO: Build completed successfully, 1 total action
```

Note the path of the file generated. You can then run the following to see the
output:

```shell
$ cat bazel-bin/ns/developer/scaffold/catalog-info.yaml
apiVersion: backstage.io/v1alpha1
kind: API
metadata:
  name: MY-API-api
  namespace: MY-NAMESPACE
  title: MY-API-TITLE
  description: MY-API-DESCRIPTION
  annotations:
    backstage.io/techdocs-ref: dir:.
spec:
  type: openapi
  owner: group:MY-NAME
  system: MY-SYSTEM
  lifecycle: experimental
  definition:
    $text: ./api/my-api.yaml
---
apiVersion: backstage.io/v1alpha1
kind: Component
metadata:
  name: MY-COMPONENT-component
  namespace: MY-NAMESPACE
  title: MY-COMPONENT-TITLE
  description: MY-COMPONENT-DESCRIPTION
  annotations:
    backstage.io/techdocs-ref: dir:.
spec:
  type: documentation
  owner: group:MY-NAME
  system: MY-SYSTEM
  lifecycle: experimental
  providesApis:
  - MY-API
---
apiVersion: backstage.io/v1alpha1
kind: Domain
metadata:
  name: MY-DOMAIN-domain
  namespace: MY-NAMESPACE
  title: MY-DOMAIN-TITLE
  description: MY-DOMAIN-DESCRIPTION
  annotations:
    backstage.io/techdocs-ref: dir:.
spec:
  owner: group:MY-NAME
---
apiVersion: backstage.io/v1alpha1
kind: System
metadata:
  name: MY-SYSTEM-system
  namespace: MY-NAMESPACE
  title: MY-SYSTEM-TITLE
  description: MY-SYSTEM-DESCRIPTION
  annotations:
    backstage.io/techdocs-ref: dir:.
spec:
  owner: group:MY-NAME
  domain: MY-DOMAIN
```

**Do not change the Bazel Target or commit the file generated, nor the values
schema YAML** as we want to keep the target flexible.

**3) Run the following:**

```shell
$ cat bazel-bin/ns/developer/scaffold/catalog-info.yaml > catalog-info.yaml
```

This will produce the first file that can be given to a team to onboard to Agora

**4) Create the MkDocs file**

We cannot currently run MkDocs with the YTT target due to the use of Pymdown
fences that are matching to YAML tags that YTT removes during the templating.

Because of this, use the following command:

```shell
$ cat ../../developer/backstage/templates/mkdocs.template.yml > mkdocs.yml
```

This will generate the correct mkdocs.yml with the default values.

**5) Add a new entry to the Backstage Configuration**

**Note:** You only need to do this if the team is running their documentation on
a GitHub repository that is NOT currently listed on the configuration for
Backstage

Go to the
following [file](../../developer/backstage/app/app-config.production-override.yaml)
and submit a PR to change the list and add a new entry:

```
catalog:
  # Used to make the catalog read only and prevent any unwanted updates
  # Ref: https://backstage.io/docs/features/software-catalog/configuration#readonly-mode
  readonly: true
  locations:
    # City Platform
    - type: github-discovery
      target: https://github.com/wp-wcm/city/blob/main/catalog-info.yaml
    - type: github-org
      target: https://github.com/wp-wcm
      rules:
        - allow: [Group, User]
    ...
    # NEW TEAM ENTRY GOES HERE
    - type: github-discovery
      target: https://github.tri-ad.tech/<ORG>/<REPO>/blob/main/catalog-info.yaml
    - type: github-org
      target: https://github.tri-ad.tech/<ORG>
      rules:
        - allow: [Group, User]
```

This change **will require a new image to be deployed to add the organization**,
this will be handled via our normal CI/CD operations

**6) Provide the team the two files generated by the runbook**
  * The `catalog-info.yaml`from steps 1-3
  * The `mkdocs.yml` from step 4