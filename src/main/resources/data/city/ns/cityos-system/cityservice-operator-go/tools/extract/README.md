# Extract Resources Generated by CityService in DEV Environment and Move to Preprod Environment

# Prerequisites
- `kubectl` must be installed.
- `yq` must be installed.

# Target Users
- Users who have utilized CityService in the DEV environment.
- Users who wish to migrate resources generated by CityService to the Preprod environment.

# Usage
1. Execute the Script
```
# Move to the working directory
cd ./tools/extract
bash extract.sh -c <kube context> -n <namespace>

# If you want to specify the output directory
bash extract.sh -c <kube context> -n <namespace> -d <exported directory>
```
- The `-c` option specifies the Kubernetes context that the script will use. Since you want to input the CityService created in the DEV environment, specify the Kubernetes context of the DEV environment.
- The `-n` option specifies the namespace used by each service team in the DEV environment.
- (Optional) The `-d` option specifies the directory where the manifests will be exported to. For example, if you specify the `../../../../../infrastructure/k8s/common/each-namespace/cityservice-extract` directory, the manifests will be exported into that directory. If not specified, the manifests will be exported to a directory named after the namespace.

2. Replace Values to Match Preprod Environment

During the script execution, the `replace_values` function is called to adjust certain fields in the manifests to match the Preprod environment. This step includes:

- Replacing the domain `cityos-dev.woven-planet.tech` with `${cluster_domain}`.
- Adjusting the gateway and service account references to match the Preprod setup.
- Changing `exportTo` in the virtualservice to match Preprod: `city-ingress` â†’ `city-private-ingress`

This ensures that the extracted resources are correctly configured for the Preprod environment.

3. Copy the files outputted to `each-namespace` or the specified directory to the corresponding directory in the Preprod environment.

Example: `city/infrastructure/k8s/common/each-namespace/cityservice-extract`.

4. Add the copied `cityservice-extract` directory to the kustomization.yaml file to ensure the resources are loaded.

Edit the `kustomization.yaml` file located at `infrastructure/k8s/common/each-namespace/kustomization.yaml` and include the path to the `cityservice-extract` directory.

5. Verify that each resource has been applied.
```
kubectl -n each-namespace get virtualservice,authorizationpolicy,serviceentry,destinationrule,keycloakclient
```

# Important Notes
- This script is currently intended for use in the Preprod environment only.
If you want to apply it to the SpeedWay environment, you need to modify the following resources to fit the SpeedWay environment:

- gateway
- serviceaccount for the gateway

# Additional Information
STS is a service with similar functionality to Drako and was used previously. However, with the transition to Preprod and Speedway environments, STS is no longer provided. Therefore, when migrating to Preprod or Speedway, you need to migrate to Drako. The method for migrating to Drako is described in this document:
Drako Migration Document

To determine if migration is necessary, check if the AuthorizationPolicy's spec.provider does not have drako-v1. If it does not, then you are using STS and need to migrate to Drako.

```
provider:
  name: "drako-v1"
```

There are two types of migration:
1. Using Authentication
2. Using Authorization
- If using Authentication, you can migrate using the method described in [this document](https://docs.google.com/document/d/1rR6tNf91CO90udqvMhKU6SnlHhsPX6YXM4y5RX_ZDdI/edit#heading=h.5qm13wuvtiz9).
- If you want to use Authorization, please consult with the Identity team (mention Slack group: `@agora-identity`) in the [wcm-org-agora-ama channel](https://toyotaglobal.enterprise.slack.com/archives/C02CVJLTMJ7) to discuss your use case and proceed with the settings together.

# Troubleshooting
For troubleshooting purposes, the script adds a annotation `cityservice-extract-script: used` to each manifest. This annotation helps in identifying and tracking resources that have been extracted using this script, distinguishing them from those handled manually.
