# Development

## Introduction

As you might know that our team uses [Rust programming language](https://www.rust-lang.org/). [`rust-analyzer`](https://rust-analyzer.github.io/) extension provides features like completion and goto definition for your IDE to help you code in Rust.

Cargo is Rust's build system and package manager. However, since we use [Bazel](https://bazel.build/about/intro) as our build and test tool, we do not run [cargo commands](https://doc.rust-lang.org/cargo/commands/index.html) directly. We use bazel commands for development.

## Commands

### Bazel

Here are some useful bazel commands that might help you getting started with bazel.

| Command                                                | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `bazel build <param>`                                  | To build a source code and its dependencies. For example, you can build drako using this command: `bazel build //ns/id/drako/...`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `bazel test <param>`                                   | To build a test code and its dependencies, and run all the corresponding tests. For example, you can build and run tests for drako specified in [drako's BUILD file](/ns/id/drako/BUILD) using this command: `bazel test //ns/id/drako/...`.                                                                                                                                                                                                                                                                                                                                                                                       |
| `bazel run <param>`                                    | To build and run an application. There are also some special use cases for `bazel run` which apply to more than an application. For instance, you can use `bazel run` instead of `bazel test` when you want to have more control over how tests are executed, e.g., running only some tests. Furthermore, running `bazel run` for docker image is perhaps the easiest way to import that docker image into your docker host, otherwise you will have to import the `.tar` archive file manually which is a bit more work. This is why in our instructions we specify `docker run :image.tar` instead of `docker build :image.tar`. |
| `bazel run //ns/id/drako:drako_test`                   | To run a bundle of tests named `drako_test` which is specified in [drako's BUILD file](/ns/id/drako/BUILD).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `bazel run ns/id/drako:image.tar`                      | To build a new image of drako based on the current source code.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `bazel run //:rustfmt`                                 | To run [rust formatting tool](https://github.com/rust-lang/rustfmt) which automatically fixes your linting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `CARGO_BAZEL_REPIN=true bazel sync --only=crate_index` | To automatically update dependencies in [`Cargo.lock`](/Cargo.lock) and [`cargo.bazel.lock`](/cargo.bazel.lock) after you manually update the dependencies described in `Cargo.toml`.                                                                                                                                                                                                                                                                                                                                                                                                                                              |

### Predefined Script

Some commands to run scripts that are available in the repository.

| Command                            | Description                                                                                                                                                                                                                                                                                                                                                                                                             |
|------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `./coverage_report.sh`             | To generate the coverage report of drako's unit tests. From the root of `city` repository, go to [ns/id/drako](/ns/id/drako/), and run this command.                                                                                                                                                                                                                                                                    |
| `./tools/generate-rust-project.sh` | Whenever [Cargo.lock](/Cargo.lock) is updated, you may want to update the [`rust-analyzer`](https://rust-analyzer.github.io/) symbol database/cache. From the root of `city` repository, run this command. For Visual Studio Code, after executing this command, you need to reload [`rust-analyzer`](https://rust-analyzer.github.io/) by selecting `rust-analyzer: Reload workspace` in `View -> Command Palette...`. |
