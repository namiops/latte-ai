## Testkube executor

### Building an image
Export variable ```DOCKER_REGISTRY```
```sh
export DOCKER_REGISTRY=docker.artifactory-ha.tri-ad.tech
```

This folder contains testkube executor for CVM. To build and push an executor image, use:
```sh
bazel run //ns/cvm/tests/testkube:push_cvm_executor_image
```

### Testing locally
To run testkube executor localy, please follow this guide:
https://github.com/wp-wcm/city/blob/main/ns/testkube/docs/01_getting-started.md

Once testkube is deployed - apply the CRs inside ```infrastructure/k8s/lab/cvm/testkube``` to your cluster:

Create test account secret:
```sh
kubectl -n testkube create secret generic bob-credentials --from-literal=username=bob --from-literal=password=<PASSWORD-FROM-LAB>
```

You can get a password from lab by executing:
```sh
kubectl -n testkube get secret bob-credentials -o jsonpath='{.data.password}' | base64 -d
```

<!-- Modify your local `serviceentries`:
```sh
kubectl -n testkube edit serviceentries.networking.istio.io
```

And add following:
```sh
spec:
  hosts:
  ...
  - id.agora-lab.woven-planet.tech  
  - cvm.agora-lab.woven-planet.tech
  - httpbin-cvm.agora-lab.woven-planet.tech
  ...
  ports:
  - name: healthcheck
    number: 6643
    protocol: HTTPS
``` -->

Once done - you are ready to launch `cvm` test from testkube UI.

## Test contents

The test code generates Certificate Signing Request(CSR) invokes CVM to sign the CSR and performs mutual TLS with the Woven App backend. The private key, the certificate signing request, and the certificate generated by the sample will be written to the local directory specified in its configuration.

### Preparation (optional)

Before running golang test code, create configuration file for it (or you can find `example-config.json` in this repo):

lab
```json
{
    "IDP_URL": "https://id.agora-lab.woven-planet.tech",
    "IDP_CLIENT_ID": "admin-cli",
    "IDP_CLIENT_SECRET": "",
    "IDP_USERNAME": <your lab username>,
    "IDP_PASSWORD": <your lab password>,
    "CVM_URL": "http://localhost:8081",
    "OUTPUT_DIR": "/path/to/tmp/cvm-output/",
    "CSR_COMMON_NAME": "app.cvm.agora-lab.woven-planet.tech",
    "CSR_KEY_TYPE": "rsa",
    "TARGET_MTLS_ENDPOINT": "https://httpbin-cvm.agora-lab.woven-planet.tech:6643/headers"
}
```

lab2
```json
{
    "IDP_URL": "https://id.agora-lab.w3n.io",
    "IDP_CLIENT_ID": "admin-cli",
    "IDP_CLIENT_SECRET": "",
    "IDP_USERNAME": <your lab2 username>,
    "IDP_PASSWORD": <your lab2 password>,
    "CVM_URL": "http://localhost:8081",
    "OUTPUT_DIR": "/tmp/cvm-output/",
    "CSR_COMMON_NAME": "app.cvm.agora-lab.w3n.io",
    "CSR_KEY_TYPE": "rsa",
    "TARGET_MTLS_ENDPOINT": "https://httpbin-cvm.agora-lab.w3n.io:6643/headers"
}
```


Note: for username and password use credentials from 
* [lab](https://id.agora-lab.woven-planet.tech/auth/realms/woven/account/#/) 
* [lab2](https://id.agora-lab.w3n.io/auth/realms/woven/account/#/)


Save this json configuration like `example-config.json`.
Make directory to store cert and key 
```sh
mkdir -p /path/to/tmp/cvm-output/
```

Then you can confirm running server on VS code and cert and key files are stored into `/path/to/tmp/cvm-output/`.

### Running the code
#### Usage with JSON configuration (preparation step required):
```sh
CONFIG_PATH=/path/to/example-config.json bazel run //ns/cvm/tests/testkube:cvm-test
```
or
```sh
CONFIG_PATH=/path/to/example-config.json go run samples/cvm-test.go
```

#### Usage with lab setup (`kubectl config use-context lab`) & testkube user (preparation step NOT needed):
```sh
USER=$(kubectl -n testkube get secret bob-credentials -o jsonpath='{.data.username}' | base64 -d) \
PWD=$(kubectl -n testkube get secret bob-credentials -o jsonpath='{.data.password}' | base64 -d) \
OUTPUT_DIR=$(mktemp -d) \
IDP_URL=https://id.agora-lab.woven-planet.tech \
IDP_CLIENT_ID=admin-cli \
IDP_USERNAME=$USER \
IDP_PASSWORD=$PWD \
CVM_URL=https://cvm.agora-lab.woven-planet.tech \
CSR_COMMON_NAME=app.cvm.agora-lab.woven-planet.tech \
CSR_KEY_TYPE=rsa \
TARGET_MTLS_ENDPOINT=https://httpbin-cvm.agora-lab.woven-planet.tech:6643/headers \
bazel run //ns/cvm/tests/testkube:cvm-test
```

#### Usage with lab2 setup (`kubectx lab2-worker1-east`) & testkube user (preparation step NOT needed):
```sh
USER=$(kubectl -n testkube get secret bob-credentials -o jsonpath='{.data.username}' | base64 -d) \
PWD=$(kubectl -n testkube get secret bob-credentials -o jsonpath='{.data.password}' | base64 -d) \
OUTPUT_DIR=$(mktemp -d) \
IDP_URL=https://id.agora-lab.w3n.io \
IDP_CLIENT_ID=admin-cli \
IDP_USERNAME=$USER \
IDP_PASSWORD=$PWD \
CVM_URL=https://cvm.agora-lab.w3n.io \
CSR_COMMON_NAME=app.cvm.agora-lab.w3n.io \
CSR_KEY_TYPE=rsa \
TARGET_MTLS_ENDPOINT=https://httpbin-cvm.agora-lab.w3n.io:6643/headers \
bazel run //ns/cvm/tests/testkube:cvm-test
```
